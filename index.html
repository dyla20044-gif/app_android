<script>
        // *** ESTO SE REEMPLAZARÁ CON LA COMPROBACIÓN REAL DE TU SCRIPT.JS ***
        // Por ahora, asumimos que no es premium para probar el muro de pago.
        let isPremiumUser = false; 

        // 1. LISTA DE FUENTES EXTERNAS (Reemplaza la lista de canales estática)
        const country_sources = {
            MX: { name: "México", url: "https://iptv-org.github.io/iptv/countries/mx.m3u" },
            EC: { name: "Ecuador", url: "https://iptv-org.github.io/iptv/countries/ec.m3u" },
            ES: { name: "España", url: "https://iptv-org.github.io/iptv/countries/es.m3u" },
            MUSIC: { name: "Música", url: "https://iptv-org.github.io/iptv/categories/music.m3u" },
            DOCS: { name: "Documentales", url: "https://iptv-org.github.io/iptv/categories/documentaries.m3u" },
            ALL: { name: "Todos", url: "https://iptv-org.github.io/iptv/index.m3u" },
            // La categoría PREMIUM de Deportes
            SPORTS: { name: "Deportes (Premium)", url: "https://iptv-org.github.io/iptv/categories/sports.m3u", premium: true }
        };

        // Almacén de canales en memoria después de cargarlos
        let cached_channels = {}; 
        
        // Variables y lógica de reproducción (Mantenida)
        const tv_video = document.getElementById('tv-video-player');
        const tv_channel_grid = document.getElementById('tv-channel-grid');
        const tv_current_name = document.getElementById('tv-current-channel-name');
        const premium_wall = document.getElementById('premium-wall');
        const country_nav = document.getElementById('country-nav');
        let tv_currentItem = null;
        let hls_instance = null;


        // ----------------------------------------------------
        // FUNCIONES CORE DE REPRODUCCIÓN (Ligeramente modificadas para usar la caché)
        // ----------------------------------------------------
        function tv_loadChannel(item, index, countryCode) {
            const channels = cached_channels[countryCode];
            if (!channels || channels.length === 0) return;

            const channel = channels[index];
            const url = channel.url;
            const name = channel.name;
            
            tv_current_name.textContent = `Reproduciendo: ${name} (${countryCode})`;
            
            // Manejo de la clase activa (rojo)
            if (tv_currentItem) {
                tv_currentItem.classList.remove('active');
            }
            item.classList.add('active');
            tv_currentItem = item;

            // Limpiar y reiniciar HLS
            if (hls_instance) {
                hls_instance.destroy();
                hls_instance = null;
            }
            
            // Cargar y reproducir (lógica HLS/Nativo)
            if (Hls.isSupported() && (url.endsWith('.m3u8') || url.includes('.m3u8'))) {
                hls_instance = new Hls();
                hls_instance.attachMedia(tv_video);
                hls_instance.on(Hls.Events.MEDIA_ATTACHED, function () {
                    hls_instance.loadSource(url);
                    hls_instance.on(Hls.Events.MANIFEST_PARSED, function () {
                        tv_video.play().catch(e => console.log("Error de auto-play:", e));
                    });
                    hls_instance.on(Hls.Events.ERROR, function (event, data) {
                        if (data.fatal) {
                            tv_current_name.textContent = `❌ ERROR: ${name} (Stream caído)`;
                            hls_instance.destroy();
                        }
                    });
                });
            } else if (tv_video.canPlayType('application/vnd.apple.mpegurl')) {
                tv_video.src = url;
                tv_video.addEventListener('loadedmetadata', function () { tv_video.play().catch(e => console.log("Error de auto-play nativo:", e)); });
            } else {
                tv_video.src = url;
                tv_video.play().catch(e => {
                    tv_current_name.textContent = `⚠️ ADVERTENCIA: Error al iniciar ${name} (URL no soportada)`;
                });
            }
        }
        
        function tv_renderChannelGrid(channels, countryCode) {
            tv_channel_grid.style.display = 'grid';
            premium_wall.style.display = 'none';

            let htmlContent = '';
            channels.forEach((channel, index) => {
                // Obtener solo el nombre del canal limpiando los atributos EXTING
                const name = channel.name.split(',').pop().trim().replace(/\s*\(.*?\)\s*$/, '');
                const info = channel.info || 'HD/SD'; // Usar la categoría si no hay info

                htmlContent += `
                    <div class="tv-grid-item" data-index="${index}" onclick="tv_loadChannel(this, ${index}, '${countryCode}')">
                        <div class="tv-grid-item-content">
                            <div class="tv-grid-item-title">${name}</div>
                            <div class="tv-grid-item-info">${info} | En vivo</div>
                        </div>
                    </div>
                `;
            });
            tv_channel_grid.innerHTML = htmlContent;
        }

        // ----------------------------------------------------
        // FUNCIÓN DE PARSEO DE M3U (Similar a la primera vez)
        // ----------------------------------------------------
        function parseM3U(m3uContent, categoryName) {
            const channels = [];
            const lines = m3uContent.split('\n');
            let currentChannel = {};

            for (const line of lines) {
                if (line.startsWith('#EXTINF:')) {
                    const nameMatch = line.match(/,(.*?)$/);
                    const name = nameMatch ? nameMatch[1].trim() : 'Canal Desconocido';
                    
                    const tvgIDMatch = line.match(/tvg-id="([^"]*)"/);
                    const tvgID = tvgIDMatch ? tvgIDMatch[1].trim() : '';

                    currentChannel = {
                        name: name,
                        info: categoryName, // Usamos el nombre de la categoría/país como info inicial
                        tvgId: tvgID
                    };
                } else if (line.startsWith('http') || line.startsWith('https')) {
                    if (currentChannel.name) {
                        currentChannel.url = line.trim();
                        channels.push(currentChannel);
                    }
                    currentChannel = {};
                }
            }
            return channels;
        }


        // ----------------------------------------------------
        // FUNCIÓN PRINCIPAL DE FILTRADO Y CARGA (MEJORADA)
        // ----------------------------------------------------
        async function tv_filterChannels(countryCode) {
            // 1. Manejo de la botonera activa
            document.querySelectorAll('#country-nav .country-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.country-button[data-country="${countryCode}"]`).classList.add('active');

            const source = country_sources[countryCode];
            
            // 2. Lógica de Muro Premium
            if (source.premium && !isPremiumUser) {
                // Mostrar muro de pago y limpiar reproductor
                tv_channel_grid.style.display = 'none';
                premium_wall.style.display = 'block';
                tv_current_name.textContent = "¡Sección Premium! Activa tu plan.";
                if (hls_instance) hls_instance.destroy();
                tv_video.src = '';
                return;
            }

            // Ocultar muro de pago y mostrar la cuadrícula
            premium_wall.style.display = 'none';
            tv_channel_grid.style.display = 'grid';
            tv_channel_grid.innerHTML = '<p style="color:#E50914; text-align:center; padding-top:20px;">Cargando canales, espera un momento...</p>';
            tv_current_name.textContent = `Cargando: ${source.name}...`;

            let channelsToRender = [];

            if (cached_channels[countryCode]) {
                // Usar caché si ya se ha cargado antes
                channelsToRender = cached_channels[countryCode];
            } else {
                // Cargar desde URL externa
                try {
                    const response = await fetch(source.url);
                    if (!response.ok) throw new Error('Error al cargar la lista M3U');

                    const m3uContent = await response.text();
                    channelsToRender = parseM3U(m3uContent, source.name);
                    
                    // Almacenar en caché
                    cached_channels[countryCode] = channelsToRender; 

                } catch (error) {
                    console.error("Fallo al obtener o parsear el M3U:", error);
                    tv_channel_grid.innerHTML = `<p style="color:#f00; text-align:center; padding-top:20px;">❌ Error al cargar canales de ${source.name}.</p>`;
                    tv_current_name.textContent = `ERROR: No se pudo cargar ${source.name}.`;
                    return;
                }
            }

            // 4. Renderizar y cargar el primer canal
            tv_renderChannelGrid(channelsToRender, countryCode);

            const firstChannel = document.querySelector('#tv-channel-grid .tv-grid-item');
            if (firstChannel) {
                // Usamos el índice 0 para cargar el primer canal de la lista
                tv_loadChannel(firstChannel, 0, countryCode); 
            } else {
                tv_current_name.textContent = `No se encontraron canales disponibles para ${source.name}.`;
                tv_channel_grid.innerHTML = `<p style="color:#aaa; text-align:center; padding-top:20px;">No hay canales en esta sección.</p>`;
                if (hls_instance) hls_instance.destroy();
                tv_video.src = '';
            }
        }

        // [ ... Mantenemos la función handleScreenNavigation y la lógica de inicialización ... ]
        function handleScreenNavigation(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.style.display = 'none';
                screen.classList.remove('active');
            });

            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.style.display = 'block';
                targetScreen.classList.add('active');
            }

            // Lógica específica para la TV: Al entrar, activar el filtro por defecto (México)
            if (screenId === 'tv-live-screen') {
                // Solo cargamos la lista si la cuadrícula está vacía (primera carga)
                if (tv_channel_grid.children.length === 0 || document.querySelector('#country-nav .country-button.active') === null) {
                    tv_filterChannels('MX');
                }
            }
        }
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    document.querySelectorAll('.bottom-nav .nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');

                    const screenId = this.getAttribute('data-screen');
                    handleScreenNavigation(screenId);
                });
            });

            const activeNav = document.querySelector('.bottom-nav .nav-item.active');
            if (activeNav) {
                const initialScreenId = activeNav.getAttribute('data-screen');
                handleScreenNavigation(initialScreenId);
            } else {
                 handleScreenNavigation('home-screen'); 
            }
            
            // Conecta el botón Premium al perfil para simular el flujo de pago
            document.querySelector('.premium-cta-btn').onclick = function() {
                handleScreenNavigation('profile-screen');
            };
        });
    </script>
    <script type="module" src="script.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
